image: php:8.3-cli

variables:
  DB_USER: root
  DB_PASSWORD: 
  DB_HOST: mysql
  DB_PORT: 3306
  DB_NAME: phpunit

services:
  - name: mysql:8.0
    alias: mysql
    variables:
      MYSQL_USER: $DB_USER
      MYSQL_PASSWORD: $DB_PASSWORD
      MYSQL_DATABASE: $DB_NAME
      MYSQL_ROOT_PASSWORD: root_password

stages: 
  - build
  - test

before_script:
  - apt-get update && apt-get install -y curl git unzip zip libzip-dev zlib1g-dev
  - docker-php-ext-install zip
  - pecl install xdebug && docker-php-ext-enable xdebug
  - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
  - php -m | grep -E 'xml|mbstring'
  - apt-get install -y lftp
  # - composer test_db

cache: 
 paths:
  - vendor/
  - ~/.composer/cache

build:
  stage: build
  script:
    - echo "Build en cours..."
    - composer install --prefer-dist --no-progress --no-suggest --no-interaction

test:
  stage: test
  variables:
    XDEBUG_MODE: coverage
  # coverage: '/Lines:\s*(\d+(\.\d+)?%?)/'
  script:
    - echo "Test en cours..."
    - composer grumphp
  artifacts:
    # reports:
    #   coverage_report:
    #     coverage_format: cobertura
    #     path: var/log/coverage/cobertura.xml